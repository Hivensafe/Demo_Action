name: Encrypt_script

on:
  workflow_dispatch:

jobs:
  encrypt-script:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache apt dependencies
      uses: actions/cache@v3
      with:
        path: |
          /var/cache/apt/archives
          /var/lib/apt/lists
        key: ${{ runner.os }}-apt-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y shc build-essential curl

    - name: Create script file
      run: |
        cat << 'UNIQUE_SCRIPT_END_MARKER' > suksu_setup.sh
        #!/bin/bash
        set -euo pipefail
        
        # å…¨å±€å˜é‡
        readonly GITHUB_ENV=${GITHUB_ENV:-".env"}
        readonly REPO_URL="https://raw.githubusercontent.com/Hivensafe/cloud_kernel_enable/main"
        readonly DEMO_REPO="https://github.com/Hivensafe/Demo_kernel.git"
        readonly ANYKERNEL_REPO="https://github.com/showdo/AnyKernel3.git"
        readonly TG_CHANNEL="https://t.me/qdykernel"
        
        # æ£€æŸ¥ç¯å¢ƒ
        check_environment() {
            if [ "${GITHUB_ACTIONS:-}" != "true" ]; then
                echo "é”™è¯¯ï¼šæ£€æµ‹åˆ°é GitHub Actions ç¯å¢ƒï¼Œç¦æ­¢æœ¬åœ°æ‰§è¡Œï¼"
                exit 1
            fi
        }
        
        # æ£€æŸ¥è¿œç¨‹çŠ¶æ€
        check_remote_status() {
            local flag
            local version
        
            # è·å–å¯ç”¨æ ‡å¿—å¹¶å»æ‰ BOM å’Œæ‰€æœ‰ç©ºç™½å­—ç¬¦
            flag=$(curl -fsSL "${REPO_URL}/enable.txt" | sed -e '1s/^\xEF\xBB\xBF//' | tr -d '[:space:]') || {
                echo "é”™è¯¯ï¼šæ— æ³•è·å–å¯ç”¨æ ‡å¿—"
                exit 1
            }
        
            # è·å–ç‰ˆæœ¬ä¿¡æ¯å¹¶å»æ‰ BOM å’Œæ‰€æœ‰ç©ºç™½å­—ç¬¦
            version=$(curl -fsSL "${REPO_URL}/main_version.txt" | sed -e '1s/^\xEF\xBB\xBF//' | tr -d '[:space:]') || {
                echo "é”™è¯¯ï¼šæ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
                exit 1
            }
        
            # è°ƒè¯•è¾“å‡ºï¼šæ£€æŸ¥ flag å’Œ version çš„å€¼
            echo "debug = '$flag'"
            echo "debug: version = '$version'"
        
            # æ£€æŸ¥å¯ç”¨æ ‡å¿—æ˜¯å¦ä¸º "on"
            if [ "$flag" != "on" ]; then
                echo "é”™è¯¯ï¼šæœåŠ¡æœªå¯ç”¨ï¼Œè¯·è”ç³»ä½œè€…"
                echo "TGé¢‘é“ï¼š${TG_CHANNEL}"
                exit 1
            fi
        
            # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ä¸º "10006"
            if [ "$version" != "10006" ]; then
                echo "é”™è¯¯ï¼šåˆ†æ”¯å·²è¿‡æœŸ (æœ€æ–°: ${version}ï¼Œå½“å‰: 10006)"
                echo "è¯·åŒæ­¥ä¸Šæ¸¸æ›´æ–°"
                echo "TGé¢‘é“ï¼š${TG_CHANNEL}"
                exit 1
            fi
        }
        
        # åˆ¶ä½œAnyKernel3åŒ…
        make_anykernel3() {
            local kernel_image="kernel_workspace/common/out/arch/arm64/boot/Image"
            local password='501b10728d2cb08abe16eb8b0bdee33c9d2382e1'
        
            echo "æ­£åœ¨åˆ¶ä½œAnyKernel3åŒ…..."
        
            if [ ! -f "$kernel_image" ]; then
                echo "é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†…æ ¸é•œåƒæ–‡ä»¶ ${kernel_image}"
                exit 1
            fi
        
            if ! git clone "${ANYKERNEL_REPO}" --depth=1; then
                echo "é”™è¯¯ï¼šå…‹éš†AnyKernel3ä»“åº“å¤±è´¥"
                exit 1
            fi
        
            rm -rf ./AnyKernel3/.git ./AnyKernel3/push.sh
        
            if ! cp "$kernel_image" ./AnyKernel3/; then
                echo "é”™è¯¯ï¼šå¤åˆ¶å†…æ ¸é•œåƒå¤±è´¥"
                exit 1
            fi
        
            if ! 7z a -t7z -p"$password" -mhe=on ./AnyKernel3/TGé¢‘é“@qdykernel.7z ./AnyKernel3/Image; then
                echo "é”™è¯¯ï¼šåˆ›å»º7zå‹ç¼©åŒ…å¤±è´¥"
                exit 1
            fi
        
            rm -f ./AnyKernel3/Image
            echo "AnyKernel3åŒ…åˆ¶ä½œå®Œæˆ"
        }

        # ä¸»ç¨‹åº
        main() {
            check_environment
            check_remote_status
        
            case "$1" in
                make_anykernel3)
                    make_anykernel3
                    ;;
                *)
                    echo "é”™è¯¯ï¼ŒæœªçŸ¥å‚æ•° $1"
                    exit 1
                    ;;
            esac
        }

        main "$@"
        UNIQUE_SCRIPT_END_MARKER
        
        chmod +x suksu_setup.sh
        echo "âœ… Script created successfully"

    - name: Verify script
      run: |
        echo "Verifying script..."
        if ! grep -q "#!/bin/bash" suksu_setup.sh; then
          echo "âŒ Missing shebang"
          exit 1
        fi
        
        if [ $(wc -l < suksu_setup.sh) -lt 10 ]; then
          echo "âŒ Script too short"
          exit 1
        fi

    - name: Encrypt script
      run: |
        echo "ğŸ”’ Starting encryption..."
        
        shc -f suksu_setup.sh -o main.bin -v -r
        
        if [ ! -f "main.bin" ]; then
          echo "âŒ Encryption failed - no output file"
          exit 1
        fi
        
        echo "Encryption successful"
        echo "File info: $(file main.bin)"
        echo "Size: $(du -h main.bin)"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: encrypted-main
        path: main.bin
        retention-days: 7
